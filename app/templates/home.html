{% extends "base.html" %}

{% block hero %}
  <div class="grid">
    <div>
      <h1>Your AI-guided path to longevity.</h1>
      <p>
        Live On curates the latest science-backed guidance on healthy aging. Explore
        featured articles, actionable tips, and soon chat with an AI longevity coach.
      </p>
      <div class="grid">
        <a role="button" href="/articles">Browse Articles</a>
        <a role="button" class="secondary" href="/tips">See Daily Tips</a>
      </div>
    </div>
    <div>
      <article>
        <header>
          <h3>What is coming next?</h3>
        </header>
        <p>
          Phase 2 establishes our Firestore-backed content hub and frontend experience.
          Next, multi-agent pipelines will keep this site refreshed with new longevity
          insights automatically.
        </p>
      </article>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section>
    <h2>Latest Articles</h2>
    {% if articles %}
      <div class="card-grid">
        {% for article in articles %}
          <article>
            <header>
              <h3>{{ article.title }}</h3>
              <p class="article-meta">Published {{ article.published_date.strftime("%B %d, %Y") }}</p>
            </header>
            {% set summary_source = article.summary if article.summary else article.content_body %}
            {% set summary_text = summary_source | markdown_to_text %}
            <p>{{ summary_text[:200] }}{% if summary_text|length > 200 %}…{% endif %}</p>
            {% if article.id %}
              <footer><a href="/articles/{{ article.id }}">Read full article</a></footer>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p>No articles are available yet. Seed Firestore to preview dynamic content.</p>
    {% endif %}
  </section>

  <section>
    <h2>Coaching Tips</h2>
    {% if tips %}
      <div class="card-grid">
        {% for tip in tips %}
          <article>
            <header>
              <h3>{{ tip.title }}</h3>
              <p class="article-meta">Published {{ tip.published_date.strftime("%B %d, %Y") }}</p>
            </header>
            <p>{{ tip.content_body }}</p>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p>No tips yet. Seed Firestore to preview coaching snippets.</p>
    {% endif %}
  </section>

  <section id="pipeline-health">
    <h2>run_pipeline Schedule Monitor</h2>
    <p>
      Capture fresh pipeline schedule metrics when investigating the
      <code>run_pipeline</code> automation. Copy the output below into the
      <code>logs/gcp_metrics</code> folder for deeper analysis later.
    </p>
    <div class="grid">
      <button type="button" id="fetch-pipeline-metrics">Fetch pipeline health metrics</button>
      <small>
        The request queries the configured pipeline backend for the last 24 hours of
        <code>run_pipeline</code> executions. Authentication relies on the server's
        runtime credentials.
      </small>
    </div>
    <p id="pipeline-backend-label">Source: awaiting first request…</p>
    <article>
      <header>
        <h3>Log output</h3>
      </header>
      <pre id="pipeline-metrics-log" class="log-window" data-status="idle">
Press the button above to load the latest metrics…
      </pre>
    </article>
  </section>

  <script>
    (() => {
      const button = document.querySelector('#fetch-pipeline-metrics');
      const logWindow = document.querySelector('#pipeline-metrics-log');
      const backendLabel = document.querySelector('#pipeline-backend-label');
      if (!button || !logWindow) {
        return;
      }

      const renderLogs = (logs) => {
        if (Array.isArray(logs) && logs.length > 0) {
          return logs.join('\n');
        }
        if (typeof logs === 'string' && logs.length > 0) {
          return logs;
        }
        return 'No log entries were returned by the monitoring endpoint.';
      };

      const describeBackend = (payload) => {
        const backend = payload?.backend;
        if (backend === 'k8s_cronjob') {
          const cronjob = payload?.cronjob ?? 'unknown CronJob';
          const namespace = payload?.namespace ? ` in namespace ${payload.namespace}` : '';
          return `Source: Kubernetes CronJob (${cronjob}${namespace})`;
        }
        if (backend === 'cloud_scheduler') {
          return 'Source: Cloud Scheduler';
        }
        return 'Source: Unknown pipeline backend';
      };

      button.addEventListener('click', async () => {
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
        logWindow.dataset.status = 'loading';
        logWindow.textContent = 'Fetching metrics from the pipeline backend…';
        if (backendLabel) {
          backendLabel.textContent = 'Source: Detecting…';
        }

        try {
          const response = await fetch('/api/metrics/run-pipeline');
          const payload = await response.json();
          const status = payload?.status ?? (response.ok ? 'success' : 'error');
          logWindow.dataset.status = response.ok ? status : 'error';
          logWindow.textContent = renderLogs(payload?.logs) ?? '';
          if (backendLabel) {
            backendLabel.textContent = describeBackend(payload);
          }

          if (!response.ok) {
            const detail = payload?.detail ?? payload?.message ?? 'Request failed.';
            logWindow.textContent += `\n\nHTTP ${response.status}: ${detail}`;
          }
        } catch (error) {
          logWindow.dataset.status = 'error';
          logWindow.textContent = `Failed to fetch metrics: ${error}`;
          if (backendLabel) {
            backendLabel.textContent = 'Source: Unable to determine backend.';
          }
        } finally {
          button.removeAttribute('aria-busy');
          button.disabled = false;
        }
      });
    })();
  </script>
{% endblock %}
